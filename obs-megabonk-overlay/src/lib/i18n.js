import { useCallback, useEffect, useMemo, useState } from 'react';
import { useOverlayStore } from '@/stores/overlayStore';

const UI_STRINGS = {
  en: {
    overlayEditor: 'Overlay Editor',
    settings: 'Settings',
    addToCanvas: 'Add to canvas',
    alignContent: 'Align Content',
    flowDirection: 'Flow Direction',
    itemOrder: 'Item Order',
    fields: 'Fields',
    rarityLimits: 'Rarity Limits',
    experimental: 'Experimental',
    horizontalGap: 'Horizontal Gap',
    verticalGap: 'Vertical Gap',
    scale: 'Scale',
    opacity: 'Opacity',
    matchEndEffects: 'Match End Effects',
    blurOnEnd: 'Blur on end',
    showEndTitle: 'Show end title',
    matchEndBlurAmount: 'Blur Amount',
    matchEndDesaturate: 'Desaturate',
    matchEndDim: 'Dim',
    fillColor: 'Fill Color',
    editTitle: 'Edit Title',
    setTitle: 'Set Title',
    clearTitle: 'Clear Title',
    showTitle: 'Show Title',
    hideTitle: 'Hide Title',
    zIndex: 'Z-Index',
    bringToFront: 'Bring to Front',
    sendToBack: 'Send to Back',
    moveForward: 'Move Forward',
    moveBackward: 'Move Backward',
    removeElement: 'Remove Element',
    addToGroup: 'Add to Group',
    noGroupsAvailable: 'No groups available',
    groupSelected: 'Group Selected',
    ungroup: 'Ungroup',
    selectMultipleToGroup: 'Select multiple to group',
    left: 'Left',
    center: 'Center',
    right: 'Right',
    row: 'Row',
    column: 'Column',
    byRarity: 'By Rarity',
    byAcquisition: 'By Acquisition',
    autoAll: 'Auto (All)',
    auto: 'Auto',
    on: 'On',
    off: 'Off',
    editTitlePrompt: 'Set a title (leave blank to clear)',
    language: 'Language',
    canvasZoomIn: 'Zoom In (Scroll)',
    canvasZoomOut: 'Zoom Out (Scroll)',
    canvasResetView: 'Reset View',
    canvasPanHint: 'Middle-click to pan',
    overlayTitle: 'Megabonk Overlay Editor',
    overlayIntro: 'Move your mouse to show the sidebar, then drag elements to the canvas or click the + button to add them.',
    overlayHintDrag: 'Drag to move elements',
    overlayHintResize: 'Resize from corners and edges',
    overlayHintSelect: 'Click element to select',
    overlayHintSettings: 'Use Settings tab for resolution',
    overlayHintZoom: 'Scroll to zoom, middle-click to pan',
    playerElements: 'Elements',
    dragElementsHint: 'Drag elements to canvas or click + to add',
    sharedElements: 'Shared Elements',
    resolution: 'Resolution',
    width: 'Width',
    height: 'Height',
    enableGridSnapping: 'Enable Grid & Snapping',
    gridActive: 'Grid and snapping are active',
    gridDisabled: 'Grid and snapping are disabled',
    gridSize: 'Grid Size (px)',
    showGridLines: 'Show Grid Lines',
    obsOverlayMode: 'OBS Overlay Mode',
    obsOverlayOn: 'ON: Background transparent, reference image hidden',
    obsOverlayOff: 'OFF: Normal editor mode with visible background',
    obsAutoHideLabels: 'Auto-hide labels in OBS',
    obsAutoHideLabelsHint: 'Hide label text when OBS mode is enabled',
    referenceImage: 'Reference Image',
    removeImage: 'Remove image',
    referenceHint: 'Upload a game screenshot to use as reference',
    iconScale: 'Icon Scale',
    iconSource: 'Icon Source',
    iconSourceCdn: 'CDN (Game Server)',
    iconSourceLocal: 'Local',
    iconSourceHintLocal: 'Using bundled icons from Game Icons folder',
    iconSourceHintCdn: 'Using icons from game CDN (requires internet)',
    historySteps: 'History Steps',
    historyHint: 'Undo/redo history size (Ctrl+Z / Ctrl+Y)',
    spectatorMode: 'Spectator Mode',
    autoDetectSpectator: 'Auto-detect spectator mode',
    spectating: 'Spectating (P1/P2 labels)',
    playing: 'Playing (You/Enemy labels)',
    roomLabel: 'Room',
    timerDirection: 'Timer Direction',
    timerCountUp: 'Count Up (Elapsed)',
    timerCountDown: 'Count Down (Remaining)',
    timerHintRemaining: 'Countdown to time limit',
    timerHintElapsed: 'Shows actual run time (excluding pause)',
    statFormat: 'Stat Formatting',
    statFormatRound: 'Round down (integer)',
    statFormatDecimal: 'One decimal place',
    statFormatHint: 'Applies only to plain values (no x or %)',
    sidebarAutoHide: 'Sidebar Auto-Hide',
    sidebarAutoHideHint: 'Hide sidebar after 3s of inactivity',
    showClippingWarnings: 'Show clipping warnings',
    showClippingWarningsHint: 'Warn when element content overflows its bounds',
    globalBlurOnMatchEnd: 'Global blur on match end',
    globalBlurOnMatchEndHint: 'Apply blur-on-end to all elements',
    sessionGamesLimit: 'Session games to show',
    sessionGamesLimitHint: 'Controls how many recent session games are shown',
    runEndEffects: 'Run End Effects',
    blurOnRunEnd: 'Blur on run end',
    blurOnRunEndHint: 'Blur and label this player when their run ends',
    addElements: 'Add elements',
    dialogAdd: 'Add',
    advancedSettings: 'Advanced Settings',
    enableAdvancedSettings: 'Enable Advanced Settings',
    advancedHint: 'Show experimental and fine-tuning controls',
    layoutSharing: 'Layout Sharing',
    layoutSharingHint: 'Copy a shareable layout string or paste one to apply a layout.',
    layoutPlaceholder: 'Paste layout string here',
    layoutGenerate: 'Generate',
    layoutCopy: 'Copy',
    layoutApply: 'Apply',
    layoutInvalid: 'Invalid layout string',
    layoutCopyFailed: 'Could not copy to clipboard',
    editTitleDialogTitle: 'Edit Title',
    editTitleDialogHint: 'Enter a title (leave blank to clear)',
    editTitlePlaceholder: 'Overlay title',
    dialogCancel: 'Cancel',
    dialogSave: 'Save',
    showIconOutlines: 'Show Icon Outlines & Fills',
    showIconOutlinesHint: 'Toggle borders, glow, and background fills',
    allowUserSelect: 'Allow Text/Image Selection',
    allowUserSelectHint: 'Enable selecting text or dragging images',
    hideElementTitles: 'Hide Element Titles',
    hideElementTitlesHint: 'Disable titles on all elements',
    fakeGameData: 'Fake Game Data',
    fakeGameDataHint: 'Override live data with spoofed values',
    generateSpoofHint: 'Generate random test data for players',
    generate: 'Generate',
    spoofMatchState: 'Matchmaking State',
    spoofMatchStateHint: 'Select a matchmaking phase for UI preview',
    spoofBansHint: 'Generate fake bans for the room',
    generateBans: 'Generate Bans',
    placedElements: 'Placed Elements',
    noElementsPlaced: 'No elements placed yet',
    playerLabel: 'Player',
    elementGroups: 'Element Groups',
    noGroups: 'No groups yet',
    elementsCount: 'elements',
    rightClickGroupHint: 'Right-click elements to group/ungroup. Groups move together.',
    noData: 'No data',
    noDamageData: 'No damage data',
    noBans: 'No bans',
    matchStatus: 'Match Status',
    queue: 'Queue',
    room: 'Room',
    phase: 'Phase',
    status: 'Status',
    winner: 'Winner',
    liveMatch: 'Live match in progress',
    seasonInfo: 'Season Info',
    timeLimit: 'Time Limit',
    pauseLimit: 'Pause Limit',
    pauseRemaining: 'Pause Remaining',
    startDate: 'Start Date',
    endDate: 'End Date',
    season: 'Season',
    gameTime: 'Game Time',
    level: 'Level',
    lvlShort: 'LVL',
    paused: 'PAUSED',
    live: 'LIVE',
    limit: 'Limit',
    countingDown: 'Counting down',
    showMore: 'Show more',
    showLess: 'Show less',
    current: 'Current',
    rank: 'Rank',
    sessionSummary: 'Session Summary',
    rating: 'Rating',
    sessionRating: 'Session Rating',
    sessionRank: 'Session Rank',
    sessionGames: 'Session Games',
    sessionStart: 'Start',
    sessionCurrent: 'Current',
    moreSources: 'more sources',
    damageSources: 'Damage Sources',
    combat: 'Combat',
    shrines: 'Shrines',
    gameStats: 'Game Stats',
    health: 'Health',
    damage: 'Damage',
    defense: 'Defense',
    utility: 'Utility',
    economy: 'Economy',
    enemyMods: 'Enemy Mods',
    matchCancelled: 'Match Cancelled',
    matchEnded: 'Match Ended',
    matchEndVictory: 'Victory',
    matchEndDefeat: 'Defeat',
    matchEndDeath: 'Death',
    matchEndTimeEnd: 'Time Ended',
    matchEndAbandoned: 'Abandoned',
    inGame: 'In Game',
    banSelection: 'Ban Selection',
    matchFound: 'Match Found',
    waitingOpponent: 'Waiting for Opponent',
    matchConfirmed: 'Match Confirmed',
    searchingMatch: 'Searching for Match',
    p1Death: 'P1 Death (Game Ongoing)',
    p2Death: 'P2 Death (Game Ongoing)',
    matchmaking: 'Matchmaking',
    player1Ready: 'Player 1 Ready',
    player2Ready: 'Player 2 Ready',
    ready: 'Ready',
    waiting: 'Waiting',
    waitingOpponentData: 'Waiting for opponent data',
    waitingOpponentDataHint: 'Opponent data has not arrived yet',
    idle: 'Idle',
    timeout: 'Timeout',
    contentClipped: 'Some content may be clipped',
    roomBans: 'Room Bans',
    player1Bans: 'Player 1 Bans',
    player2Bans: 'Player 2 Bans',
    unknown: 'Unknown',
    common: 'Common',
    rare: 'Rare',
    epic: 'Epic',
    legendary: 'Legendary',
    kills: 'Kills',
    gold: 'Gold',
    damageDealt: 'Damage Dealt',
    damageTaken: 'Damage Taken',
    balance: 'Balance',
    greed: 'Greed',
    challenge: 'Challenge',
    cursed: 'Cursed',
    magnet: 'Magnet',
    moai: 'Moai',
    charge: 'Charge',
    goldenCharge: 'Golden Charge',
    goldEarned: 'Gold Earned',
    goldSpent: 'Gold Spent',
    xpGained: 'XP Gained',
    eliteKills: 'Elite Kills',
    bossKills: 'Boss Kills',
    minibossKills: 'Miniboss Kills',
    skeletonKills: 'Skeleton Kills',
    goblinKills: 'Goblin Kills',
    fireKills: 'Fire Kills',
    lightningKills: 'Lightning Kills',
    projectilesFired: 'Projectiles Fired',
    itemsPickedUp: 'Items Picked Up',
    chestsOpened: 'Chests Opened',
    chestsBought: 'Chests Bought',
    potsBroken: 'Pots Broken',
    powerupsUsed: 'Powerups Used',
    selected: 'selected',
    'Normal Chests': 'Normal Chests',
    'Corrupt Chests': 'Corrupt Chests',
    'Free Chests': 'Free Chests',
    'Balance Shrines': 'Balance Shrines',
    'Greed Shrines': 'Greed Shrines',
    'Challenge Shrines': 'Challenge Shrines',
    'Cursed Shrines': 'Cursed Shrines',
    'Magnet Shrines': 'Magnet Shrines',
    'Moai Shrines': 'Moai Shrines',
    'Charge Shrines': 'Charge Shrines',
    'Golden Charges': 'Golden Charges',
    'Silver Earned': 'Silver Earned',
    'Final Boss Kills': 'Final Boss Kills',
    'Critical Hits': 'Critical Hits',
    'Lifesteal Heals': 'Lifesteal Heals',
    'Items Picked': 'Items Picked',
    'category.equipment': 'Equipment',
    'category.items': 'Items',
    'category.stats': 'Stats (Groups)',
    'category.stats-individual': 'Stats (Individual)',
    'category.combat': 'Combat (Groups)',
    'category.combat-individual': 'Combat (Individual)',
    'category.game-info': 'Game Info',
    'category.match': 'Matchmaking',
    'category.bans': 'Room Bans',
    'category.season': 'Season Info',
    'category.shapes': 'Shapes',
    // Smart Interactions
    smartInteractions: 'Smart Interactions',
    smartInteractionsHint: 'Show animated notifications when stats or items change from interactions.',
    interactionTypes: 'Interaction Types',
    displaySettings: 'Display Settings',
    displayDuration: 'Display Duration',
    maxVisibleEvents: 'Max Visible Events',
    animationStyle: 'Animation Style',
    animationSlide: 'Slide',
    animationFade: 'Fade',
    animationPop: 'Pop',
    showStatChanges: 'Show Stat Changes',
    showItemChanges: 'Show Item Changes',
    clearEvents: 'Clear Events',
    chests: 'Chests',
    goldenShrines: 'Golden Shrines',
    chaosTome: 'Chaos Tome',
    microwaveUpgrade: 'Microwave',
    shadyGuy: 'Shady Guy'
  },
  ru: {
    overlayEditor: 'Редактор оверлея',
    settings: 'Настройки',
    addToCanvas: 'Добавить на холст',
    alignContent: 'Выравнивание',
    flowDirection: 'Направление',
    itemOrder: 'Порядок предметов',
    fields: 'Поля',
    rarityLimits: 'Лимиты редкости',
    experimental: 'Экспериментальное',
    horizontalGap: 'Горизонтальный отступ',
    verticalGap: 'Вертикальный отступ',
    scale: 'Масштаб',
    opacity: 'Прозрачность',
    matchEndEffects: 'Эффекты конца матча',
    blurOnEnd: 'Блюр после матча',
    showEndTitle: 'Показать заголовок',
    matchEndBlurAmount: 'Сила блюра',
    matchEndDesaturate: 'Обесцветить',
    matchEndDim: 'Затемнение',
    fillColor: 'Цвет заливки',
    editTitle: 'Редактировать заголовок',
    setTitle: 'Задать заголовок',
    clearTitle: 'Сбросить заголовок',
    showTitle: 'Показать заголовок',
    hideTitle: 'Скрыть заголовок',
    zIndex: 'Слой',
    bringToFront: 'На передний план',
    sendToBack: 'На задний план',
    moveForward: 'Вперёд',
    moveBackward: 'Назад',
    removeElement: 'Удалить',
    addToGroup: 'Добавить в группу',
    noGroupsAvailable: 'Группы отсутствуют',
    groupSelected: 'Сгруппировать',
    ungroup: 'Разгруппировать',
    selectMultipleToGroup: 'Выберите несколько для группы',
    left: 'Слева',
    center: 'По центру',
    right: 'Справа',
    row: 'Ряд',
    column: 'Колонка',
    byRarity: 'По редкости',
    byAcquisition: 'По получению',
    autoAll: 'Авто (все)',
    auto: 'Авто',
    on: 'Вкл',
    off: 'Выкл',
    editTitlePrompt: 'Введите заголовок (пусто — сбросить)',
    language: 'Язык',
    canvasZoomIn: 'Приблизить (колёсико)',
    canvasZoomOut: 'Отдалить (колёсико)',
    canvasResetView: 'Сбросить вид',
    canvasPanHint: 'Средняя кнопка — панорама',
    overlayTitle: 'Редактор оверлея Megabonk',
    overlayIntro: 'Наведите курсор, чтобы показать панель, затем перетащите элементы на холст или нажмите +.',
    overlayHintDrag: 'Перетаскивайте элементы',
    overlayHintResize: 'Изменяйте размер за углы и края',
    overlayHintSelect: 'Клик — выбрать элемент',
    overlayHintSettings: 'Настройки разрешения — в Settings',
    overlayHintZoom: 'Колёсико — масштаб, средняя кноп кноп — панорама',
    playerElements: 'Элементы',
    dragElementsHint: 'Перетаскивайте элементы на холст или нажмите +',
    sharedElements: 'Общие элементы',
    resolution: 'Разрешение',
    width: 'Ширина',
    height: 'Высота',
    enableGridSnapping: 'Сетка и привязка',
    gridActive: 'Сетка и привязка включены',
    gridDisabled: 'Сетка и привязка выключены',
    gridSize: 'Шаг сетки (px)',
    showGridLines: 'Показывать линии сетки',
    obsOverlayMode: 'Режим OBS',
    obsOverlayOn: 'ВКЛ: фон прозрачный, референс скрыт',
    obsOverlayOff: 'ВЫКЛ: обычный режим с фоном',
    obsAutoHideLabels: 'Скрывать подписи в OBS',
    obsAutoHideLabelsHint: 'Скрывать текстовые метки в OBS режиме',
    referenceImage: 'Референс',
    removeImage: 'Удалить изображение',
    referenceHint: 'Загрузите скриншот для ориентира',
    iconScale: 'Масштаб иконок',
    iconSource: 'Источник иконок',
    iconSourceCdn: 'CDN (сервер игры)',
    iconSourceLocal: 'Локально',
    iconSourceHintLocal: 'Используются локальные иконки',
    iconSourceHintCdn: 'Иконки с CDN (нужен интернет)',
    historySteps: 'Шаги истории',
    historyHint: 'Размер истории (Ctrl+Z / Ctrl+Y)',
    spectatorMode: 'Режим зрителя',
    autoDetectSpectator: 'Автоопределение режима зрителя',
    spectating: 'Зритель (метки P1/P2)',
    playing: 'Играете (метки Вы/Враг)',
    roomLabel: 'Комната',
    timerDirection: 'Направление таймера',
    timerCountUp: 'Счёт вверх (прошло)',
    timerCountDown: 'Счёт вниз (остаток)',
    timerHintRemaining: 'Отсчёт до лимита времени',
    timerHintElapsed: 'Фактическое время игры (без пауз)',
    statFormat: 'Формат статов',
    statFormatRound: 'Округлять вниз (целое)',
    statFormatDecimal: 'Одна цифра после точки',
    sessionGamesLimit: 'Кол-во сессионных игр',
    sessionGamesLimitHint: 'Сколько последних игр сессии показывать',
    runEndEffects: 'Эффекты конца раунда',
    blurOnRunEnd: 'Блюр после раунда',
    blurOnRunEndHint: 'Блюрить и показывать метку когда раунд игрока закончен',
    addElements: 'Добавить элементы',
    dialogAdd: 'Добавить',
    statFormatHint: 'Только для обычных значений (без x или %)',
    sidebarAutoHide: 'Автоскрытие панели',
    sidebarAutoHideHint: 'Скрывать панель через 3с бездействия',
    showClippingWarnings: 'Показывать предупреждения об обрезке',
    showClippingWarningsHint: 'Предупреждать, если содержимое выходит за границы',
    globalBlurOnMatchEnd: 'Глобальный блюр после матча',
    globalBlurOnMatchEndHint: 'Применять blur-on-end ко всем элементам',
    advancedSettings: 'Расширенные настройки',
    enableAdvancedSettings: 'Включить расширенные настройки',
    advancedHint: 'Показать экспериментальные и тонкие настройки',
    layoutSharing: 'Обмен раскладками',
    layoutSharingHint: 'Скопируйте строку раскладки или вставьте её для применения.',
    layoutPlaceholder: 'Вставьте строку раскладки',
    layoutGenerate: 'Сгенерировать',
    layoutCopy: 'Копировать',
    layoutApply: 'Применить',
    layoutInvalid: 'Неверная строка раскладки',
    layoutCopyFailed: 'Не удалось скопировать в буфер',
    editTitleDialogTitle: 'Редактировать заголовок',
    editTitleDialogHint: 'Введите заголовок (пусто — сбросить)',
    editTitlePlaceholder: 'Заголовок оверлея',
    dialogCancel: 'Отмена',
    dialogSave: 'Сохранить',
    showIconOutlines: 'Контуры и заливки иконок',
    showIconOutlinesHint: 'Границы, свечение и фон',
    allowUserSelect: 'Разрешить выделение',
    allowUserSelectHint: 'Выделение текста или перетаскивание изображений',
    hideElementTitles: 'Скрыть заголовки элементов',
    hideElementTitlesHint: 'Отключить заголовки у всех элементов',
    fakeGameData: 'Поддельные данные',
    fakeGameDataHint: 'Подменить данные тестовыми',
    generateSpoofHint: 'Сгенерировать тестовые данные для игроков',
    generate: 'Сгенерировать',
    spoofMatchState: 'Состояние матча',
    spoofMatchStateHint: 'Выберите стадию для предпросмотра UI',
    spoofBansHint: 'Сгенерировать фейковые баны комнаты',
    generateBans: 'Сгенерировать баны',
    placedElements: 'Размещённые элементы',
    noElementsPlaced: 'Элементы ещё не добавлены',
    playerLabel: 'Игрок',
    elementGroups: 'Группы элементов',
    noGroups: 'Групп ещё нет',
    elementsCount: 'элементов',
    rightClickGroupHint: 'Правый клик — группировка/разгруппировка. Группы двигаются вместе.',
    noData: 'Нет данных',
    noDamageData: 'Нет данных по урону',
    noBans: 'Банов нет',
    matchStatus: 'Статус матча',
    queue: 'Очередь',
    room: 'Комната',
    phase: 'Фаза',
    status: 'Статус',
    winner: 'Победитель',
    liveMatch: 'Матч идёт',
    seasonInfo: 'Инфо сезона',
    timeLimit: 'Лимит времени',
    pauseLimit: 'Лимит паузы',
    pauseRemaining: 'Остаток паузы',
    startDate: 'Дата начала',
    endDate: 'Дата конца',
    season: 'Сезон',
    gameTime: 'Время игры',
    level: 'Уровень',
    lvlShort: 'LVL',
    paused: 'ПАУЗА',
    live: 'LIVE',
    limit: 'Лимит',
    countingDown: 'Обратный отсчёт',
    showMore: 'Показать ещё',
    showLess: 'Скрыть',
    current: 'Текущий',
    rank: 'Ранг',
    sessionSummary: 'Сводка сессии',
    rating: 'Рейтинг',
    sessionRating: 'Рейтинг сессии',
    sessionRank: 'Ранг сессии',
    sessionGames: 'Игры сессии',
    sessionStart: 'Начало',
    sessionCurrent: 'Текущий',
    moreSources: 'ещё источников',
    damageSources: 'Источники урона',
    combat: 'Бой',
    shrines: 'Святыни',
    gameStats: 'Статы игры',
    health: 'Здоровье',
    damage: 'Урон',
    defense: 'Защита',
    utility: 'Утилита',
    economy: 'Экономика',
    enemyMods: 'Модификаторы врагов',
    matchCancelled: 'Матч от отменён',
    matchEnded: 'Матч завершён',
    matchEndVictory: 'Победа',
    matchEndDefeat: 'Поражение',
    matchEndDeath: 'Смерть',
    matchEndTimeEnd: 'Время истекло',
    p1Death: 'Смерть P1 (игра идёт)',
    p2Death: 'Смерть P2 (игра идёт)',
    matchEndAbandoned: 'Покинул',
    inGame: 'В игре',
    banSelection: 'Выбор банов',
    matchFound: 'Матч найден',
    waitingOpponent: 'Ожидание соперника',
    matchConfirmed: 'Матч под подтверждён',
    searchingMatch: 'Поиск матча',
    matchmaking: 'Матчмейкинг',
    player1Ready: 'Игрок 1 готов',
    player2Ready: 'Игрок 2 готов',
    ready: 'Готов',
    waiting: 'Ожидание',
    waitingOpponentData: 'Ожидание данных соперника',
    waitingOpponentDataHint: 'Данные соперника ещё не пришли',
    idle: 'Ожидание',
    timeout: 'Таймаут',
    contentClipped: 'Часть содержимого может быть обрезана',
    roomBans: 'Баны комнаты',
    player1Bans: 'Баны игрока 1',
    player2Bans: 'Баны игрока 2',
    unknown: 'Неизвестно',
    common: 'Обычные',
    rare: 'Редкие',
    epic: 'Эпические',
    legendary: 'Легендарные',
    kills: 'Убийства',
    gold: 'Золото',
    damageDealt: 'Нанесённый урон',
    damageTaken: 'Полученный урон',
    balance: 'Баланс',
    greed: 'Жадность',
    challenge: 'Испытание',
    cursed: 'Проклятие',
    magnet: 'Магнит',
    moai: 'Моаи',
    charge: 'Заряд',
    goldenCharge: 'Золотой заряд',
    goldEarned: 'Золото получено',
    goldSpent: 'Золото потрачено',
    xpGained: 'XP получено',
    eliteKills: 'Убийства элит',
    bossKills: 'Убийства боссов',
    minibossKills: 'Убийства минибоссов',
    skeletonKills: 'Убийства скелетов',
    goblinKills: 'Убийства гоблинов',
    fireKills: 'Убийства огнём',
    lightningKills: 'Убийства молнией',
    projectilesFired: 'Снаряды выпущены',
    itemsPickedUp: 'Предметововнято',
    chestsOpened: 'Сундуков открыто',
    chestsBought: 'Сундуков куплено',
    potsBroken: 'Горшков разбито',
    powerupsUsed: 'Бафов использовано',
    selected: 'выбрано',
    'Normal Chests': 'Обычные сундуки',
    'Corrupt Chests': 'Порч. сундуки',
    'Free Chests': 'Бесплатные сундуки',
    'Balance Shrines': 'Святыни баланса',
    'Greed Shrines': 'Святыни жадности',
    'Challenge Shrines': 'Святыни испытаний',
    'Cursed Shrines': 'Проклятые святыни',
    'Magnet Shrines': 'Святыни магнита',
    'Moai Shrines': 'Святыни моаи',
    'Charge Shrines': 'Святыни заряда',
    'Golden Charges': 'Золотые заряды',
    'Silver Earned': 'Серебро получено',
    'Final Boss Kills': 'Убийства фин. босса',
    'Critical Hits': 'Критические удары',
    'Lifesteal Heals': 'Лайфстил лечение',
    'Items Picked': 'Предметы подняты',
    'category.equipment': 'Экипировка',
    'category.items': 'Предметы',
    'category.stats': 'Статы (группы)',
    'category.stats-individual': 'Статы (индивидуальные)',
    'category.combat': 'Бой (группы)',
    'category.combat-individual': 'Бой (индивидуальный)',
    'category.game-info': 'Инфо игры',
    'category.match': 'Матчи',
    'category.bans': 'Баны комнаты',
    'category.season': 'Сезон',
    'category.shapes': 'Фигуры',
    // Smart Interactions
    smartInteractions: 'Умные взаимодействия',
    smartInteractionsHint: 'Показывать анимированные уведомления при приении статов или предметов.',
    interactionTypes: 'Типы взаимодействий',
    displaySettings: 'Настройки отображения',
    displayDuration: 'Длительность показа',
    maxVisibleEvents: 'Макс. видимых событий',
    animationStyle: 'Стиль анимации',
    animationSlide: 'Скольжение',
    animationFade: 'Затухание',
    animationPop: 'Всплытие',
    showStatChanges: 'Показывать статы',
    showItemChanges: 'Показывать предметы',
    clearEvents: 'Очистить события',
    chests: 'Сундуки',
    goldenShrines: 'Золотые святыни',
    chaosTome: 'Том хаоса',
    microwaveUpgrade: 'Микроволновка',
    shadyGuy: 'Тёмный торговец'
  }
};

const ELEMENT_TRANSLATIONS = {
  ru: {
    hero: { label: 'Герой', description: 'Показать текущего героя' },
    weapons: { label: 'Оружие', description: 'Показать экипированные оружие' },
    tomes: { label: 'Томы', description: 'Показать экипированные томы' },
    'bonk-classic': { label: 'Бонк классик', description: 'Оружие сверху, томы снизу' },
    'item-group': { label: 'Все предметы', description: 'Все предметы по редкости' },
    'rarity-group-common': { label: 'Обычные предметы', description: 'Только обычные (зелёные) предметы' },
    'rarity-group-rare': { label: 'Редкие предметы', description: 'Только редкие (синие) предметы' },
    'rarity-group-epic': { label: 'Эпические предметы', description: 'Только эпические (фиолетовые) предметы' },
    'rarity-group-legendary': { label: 'Легендарные предметы', description: 'Только легендарные (золотые) предметы' },
    'stats-health': { label: 'Статы здоровья', description: 'HP, реген, щит, оверхил' },
    'stats-damage': { label: 'Статы урона', description: 'Урон, крит, скорость атаки' },
    'stats-defense': { label: 'Статы защиты', description: 'Броня, уклонение, шипы' },
    'stats-utility': { label: 'Статы утилиты', description: 'Скорость, прыжок, радиус' },
    'stats-economy': { label: 'Статы экономики', description: 'Золото, XP, серебро, удача' },
    'stats-enemy': { label: 'Статы врагов', description: 'Сложность, модификаторы' },
    'stat-maxhealth': { label: 'Макс. здоровье', description: 'Максимум HP' },
    'stat-healthregen': { label: 'Реген здоровья', description: 'Скорость регена HP' },
    'stat-shield': { label: 'Щит', description: 'Значение щита' },
    'stat-overheal': { label: 'Оверхил', description: 'Объём оверхила' },
    'stat-healingmultiplier': { label: 'Множ. лечения', description: 'Множитель лечения' },
    'stat-lifesteal': { label: 'Лайфстил', description: 'Процент вампиризма' },
    'stat-damagemultiplier': { label: 'Множ. урона', description: 'Множитель урона' },
    'stat-attackspeed': { label: 'Скорость атаки', description: 'Значение скорости' },
    'stat-critchance': { label: 'Шанс крита', description: 'Шанс крит. удара' },
    'stat-critdamage': { label: 'Урон крита', description: 'Множитель крита' },
    'stat-projectiles': { label: 'Снаряды', description: 'Количество снарядов' },
    'stat-projectilebounces': { label: 'Рикошеты', description: 'Рикошеты снарядов' },
    'stat-projectilespeedmultiplier': { label: 'Скорость снарядов', description: 'Скорость снарядов' },
    'stat-armor': { label: 'Броня', description: 'Значение брони' },
    'stat-evasion': { label: 'Уклонение', description: 'Шанс уклонения' },
    'stat-thorns': { label: 'Шипы', description: 'Урон шипами' },
    'stat-damagereductionmultiplier': { label: 'Снижение урона', description: 'Снижение урона' },
    'stat-firedamage': { label: 'Огн. урон', description: 'Множитель огня' },
    'stat-icedamage': { label: 'Лед. урон', description: 'Множитель льда' },
    'stat-lightningdamage': { label: 'Молния', description: 'Множитель молнии' },
    'stat-burnchance': { label: 'Шанс горения', description: 'Шансансжога' },
    'stat-freezechance': { label: 'Шанс заморозки', description: 'Шанс заморозки' },
    'stat-movespeedmultiplier': { label: 'Скорость бега', description: 'Скорость движения' },
    'stat-jumpheight': { label: 'Высота прыжка', description: 'Высота прыжка' },
    'stat-extrajumps': { label: 'Доп. прыжки', description: 'Дополнительные прыжки' },
    'stat-pickuprange': { label: 'Радиус сбора', description: 'Радиус подбора' },
    'stat-sizemultiplier': { label: 'Размер', description: 'Размер персонажа' },
    'stat-durationmultiplier': { label: 'Длительность', description: 'Длительность эффектов' },
    'stat-knockbackmultiplier': { label: 'Отбрасывание', description: 'Сила отбрасывания' },
    'stat-luck': { label: 'Удача', description: 'Значение удачи' },
    'stat-goldincreasemultiplier': { label: 'Множ. золота', description: 'Увеличение золота' },
    'stat-xpincreasemultiplier': { label: 'Множ. XP', description: 'Увеличение XP' },
    'stat-silverincreasemultiplier': { label: 'Множ. серебра', description: 'Увеличение серебра' },
    'stat-chestincreasemultiplier': { label: 'Множ. сундуков', description: 'Увеличение сундуков' },
    'stat-chestpricemultiplier': { label: 'Цена сундука', description: 'Множитель цены' },
    'stat-shoppricereduction': { label: 'Скидка магазина', description: 'Снижение цен' },
    'stat-powerupboostmultiplier': { label: 'Усиление бафов', description: 'Сила бафов' },
    'stat-powerupchance': { label: 'Шанс бафа', description: 'Шанс выпадения' },
    'stat-difficulty': { label: 'Сложность', description: 'Текущая сложность' },
    'stat-elitespawnincrease': { label: 'Элитные враги', description: 'Частота элитных' },
    'stat-enemyamountmultiplier': { label: 'Кол-во врагов', description: 'Множитель спавна' },
    'stat-enemysizemultiplier': { label: 'размер врагов', description: 'Множитель размера' },
    'stat-enemyspeedmultiplier': { label: 'Скорость врагов', description: 'Множитель скорости' },
    'stat-enemyhpmultiplier': { label: 'HP врагов', description: 'Множитель HP' },
    'stat-enemydamagemultiplier': { label: 'Урон врагов', description: 'Множитель урона' },
    'stat-enemyscalingmultiplier': { label: 'Скалирование врагов', description: 'Темп усиления' },
    'stat-elitedamagemultiplier': { label: 'Урон элитных', description: 'Множитель урона элитных' },
    'stat-holiness': { label: 'Святость', description: 'Значение святости' },
    'stat-wickedness': { label: 'Порочность', description: 'Значение порочности' },
    'stat-evolve': { label: 'Эволюция', description: 'Прогресс эволюции' },
    'stat-weaponburstcooldown': { label: 'КД рывка', description: 'Перезарядка рывка' },
    'stat-damagecooldownmultiplier': { label: 'Множ. КД урона', description: 'Множитель КД' },
    'stat-effectdurationmultiplier': { label: 'Длит. эффектов', description: 'Длительность эффектов' },
    'stat-falldamagereduction': { label: 'Снижение падения', description: 'Снижение урона от падения' },
    'stat-slam': { label: 'Удар', description: 'Урон удара' },
    'combat-stats': { label: 'Статы боя', description: 'Убийства, золото, урон' },
    'shrine-stats': { label: 'Статы святынь', description: 'Использование святынь' },
    'game-stats': { label: 'Статы игры', description: 'Подробная статистика' },
    'damage-sources': { label: 'Источники урона', description: 'Урон по оружию' },
    'combat-killcount': { label: 'Убийства', description: 'Всего убийств' },
    'combat-currentgold': { label: 'Текущее золото', description: 'Текущее количество' },
    'combat-totaldamagedealt': { label: 'Нанесённый урон', description: 'Всего нанесено' },
    'combat-totaldamagetaken': { label: 'Полученный урон', description: 'Всего получено' },
    'combat-chestsnormal': { label: 'Обычные сундуки', description: 'Открыто обычных' },
    'combat-chestscorrupt': { label: 'Порч. сундуки', description: 'Открыто порченных' },
    'combat-chestsfree': { label: 'Бесплатные сундуки', description: 'Открыто бесплатных' },
    'combat-shrinebalance': { label: 'Святыни баланса', description: 'Использовано' },
    'combat-shrinegreed': { label: 'Святыни жадности', description: 'Использовано' },
    'combat-shrinechallenge': { label: 'Святыни испытаний', description: 'Использовано' },
    'combat-shrinecursed': { label: 'Проклятые святыни', description: 'Использовано' },
    'combat-shrinemagnet': { label: 'Святыни магнита', description: 'Использовано' },
    'combat-shrinemoai': { label: 'Святыни моаи', description: 'Использовано' },
    'combat-shrinechargenormal': { label: 'Святыни заряда', description: 'Обычный заряд' },
    'combat-shrinechargegolden': { label: 'Золотой заряд', description: 'Золотые заряды' },
    'combat-goldearned': { label: 'Золото получено', description: 'Всего получено' },
    'combat-goldspent': { label: 'Золото потрачено', description: 'Всего потрачено' },
    'combat-silverearned': { label: 'Серебро получено', description: 'Всего получено' },
    'combat-xpgained': { label: 'XP получено', description: 'Всего получено' },
    'combat-elitekills': { label: 'Убийства элит', description: 'Элитные убиты' },
    'combat-bosskills': { label: 'Убийства боссов', description: 'Боссы убиты' },
    'combat-minibosskills': { label: 'Убийства минибоссов', description: 'Минибоссы убиты' },
    'combat-finalbosskills': { label: 'Убийства фин. босса', description: 'Финальные боссы' },
    'combat-crits': { label: 'Криты', description: 'Критические удары' },
    'combat-evades': { label: 'Уклонения', description: 'Количество уклонений' },
    'combat-projectilesfired': { label: 'Снаряды выпущены', description: 'Всего снарядов' },
    'combat-lifestealhealing': { label: 'Лайфстил лечение', description: 'Восстановлено' },
    'combat-itemspickedup': { label: 'Предметы подняты', description: 'Всего поднято' },
    'combat-chestsopened': { label: 'Сундуков открыто', description: 'Всего открыто' },
    'combat-chestsbought': { label: 'Сундуков куплено', description: 'Всего куплено' },
    'combat-potsbroken': { label: 'Горшков разбито', description: 'Всего разбито' },
    'combat-powerupsused': { label: 'Бафов использовано', description: 'Всего использовано' },
    'game-time': { label: 'Время игры', description: 'Прошедшее время' },
    'game-level': { label: 'Уровень', description: 'Текущий уровень' },
    'pause-limit': { label: 'Лимит паузы', description: 'Общий лимит паузы' },
    'pause-remaining': { label: 'Остаток паузы', description: 'Оставшееся время паузы' },
    'time-diff': { label: 'Разница времени', description: 'Разница времени с соперником' },
    'difficulty-diff': { label: 'Разница сложности', description: 'Разница сложности с соперником' },
    'kill-diff': { label: 'Разница убийств', description: 'Разница убийств с соперником' },
    'match-flow': { label: 'Ход матча', description: 'Очередь и статус' },
    'match-search': { label: 'Поиск матча', description: 'Индикатор поиска матча' },
    'match-ban-selection': { label: 'Выбор банов', description: 'Статус банов' },
    'match-opponent-wait': { label: 'Ожидание соперника', description: 'Ожидание данных соперника' },
    'match-smart': { label: 'Умный матчмейкинг', description: 'Поиск, баны и ожидание соперника' },
    'season-info': { label: 'Информация сезона', description: 'Название, лимиты, даты' },
    'season-name': { label: 'Название сезона', description: 'Только название' },
    'season-time-limit': { label: 'Лимит времени', description: 'Лимит времени сезона' },
    'season-pause-limit': { label: 'Лимит паузы', description: 'Лимит паузы' },
    'season-start-date': { label: 'Дата начала', description: 'Дата начала сезона' },
    'season-end-date': { label: 'Дата конца', description: 'Дата конца сезона' },
    'bans-system': { label: 'Баны комнаты', description: 'Системные баны' },
    'bans-player1': { label: 'Баны игрока 1', description: 'Баны игрока 1' },
    'bans-player2': { label: 'Баны игрока 2', description: 'Баны игрока 2' },
    'shape-rect': { label: 'Цветовой блок', description: 'Сплошная заливка' },
    'smart-interactions': { label: 'Умные взаимодействия', description: 'Анимированные уведомления о событиях' }
  }
};

const normalizeKey = (value) => String(value || '')
  .replace(/[\s_-]+/g, '')
  .toLowerCase();

let cachedTranslations = null;
let translationsPromise = null;
const translationsSubscribers = new Set();

const notifyTranslationsSubscribers = (data) => {
  translationsSubscribers.forEach((callback) => callback(data));
};

const fetchTranslationsOnce = () => {
  if (cachedTranslations) return Promise.resolve(cachedTranslations);
  if (translationsPromise) return translationsPromise;

  translationsPromise = fetch('http://localhost:17502/translations')
    .then((response) => (response.ok ? response.json() : null))
    .then((data) => {
      if (data) {
        cachedTranslations = data;
        notifyTranslationsSubscribers(data);
      }
      return data;
    })
    .catch(() => null)
    .finally(() => {
      translationsPromise = null;
    });

  return translationsPromise;
};

const buildNormalizedSections = (apiData, language) => {
  const translations = apiData?.translations?.[language] || apiData?.translations?.en;
  if (!translations) return null;

  const normalized = {};
  Object.entries(translations).forEach(([section, entries]) => {
    if (!entries || typeof entries !== 'object') return;
    const map = {};
    Object.entries(entries).forEach(([key, value]) => {
      map[normalizeKey(key)] = value;
    });
    normalized[section] = map;
  });
  return normalized;
};

export function useI18n() {
  const language = useOverlayStore((state) => state.language);
  const setLanguage = useOverlayStore((state) => state.setLanguage);
  const [apiTranslations, setApiTranslations] = useState(() => cachedTranslations);

  useEffect(() => {
    let mounted = true;

    const handleUpdate = (data) => {
      if (mounted && data) {
        setApiTranslations(data);
      }
    };

    translationsSubscribers.add(handleUpdate);
    fetchTranslationsOnce();

    return () => {
      mounted = false;
      translationsSubscribers.delete(handleUpdate);
    };
  }, []);

  useEffect(() => {
    if (typeof document !== 'undefined') {
      document.documentElement.lang = language || 'en';
    }
  }, [language]);

  const uiStrings = useMemo(() => (UI_STRINGS[language] || UI_STRINGS.en), [language]);
  const elementStrings = useMemo(() => (ELEMENT_TRANSLATIONS[language] || {}), [language]);
  const normalizedSections = useMemo(() => buildNormalizedSections(apiTranslations, language), [apiTranslations, language]);

  const t = useCallback((key, fallback) => {
    if (!key) return fallback ?? '';
    return uiStrings?.[key] ?? UI_STRINGS.en?.[key] ?? fallback ?? key;
  }, [uiStrings]);

  const tGameData = useCallback((section, key, fallback) => {
    if (!key || !section) return fallback ?? '';
    const normalized = normalizeKey(key);
    const value = normalizedSections?.[section]?.[normalized];
    return value ?? fallback ?? key;
  }, [normalizedSections]);

  const tStat = useCallback((statKey, fallback) => (
    tGameData('stats', statKey, fallback)
  ), [tGameData]);

  const getElementLabel = useCallback((type, fallback) => (
    elementStrings?.[type]?.label ?? fallback ?? type
  ), [elementStrings]);

  const getElementDescription = useCallback((type, fallback) => (
    elementStrings?.[type]?.description ?? fallback ?? ''
  ), [elementStrings]);

  return {
    language,
    setLanguage,
    t,
    tGameData,
    tStat,
    getElementLabel,
    getElementDescription,
  };
}
